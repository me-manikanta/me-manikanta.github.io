{"pageProps":{"frontMatter":{"title":"How-to: Python Paramiko","date":"March 6, 2022","description":"A how-to guide for using the Python Paramiko library."},"slug":"python-paramiko","content":"\n# Background\n\nI recently had a task that required me to connect to an SFTP server, download particular files (if they existed), and then process the contents. We were given the option of using any language to fulfil the criteria, so I chose Python to tackle the problem. This blog outlines the problems I encountered when attempting to build the script, as well as a tutorial on how to use the library.\n\n## Why not an alternative lib something like `pysftp`\n\n[This](https://stackoverflow.com/questions/48434941/pysftp-vs-paramiko) StackOverflow answer lists the differences between the libraries.\n\n# Requirements\n\n## Verify Python\n\nWe need to have some version of python installed in our machine to use the library, in my case I am currently using `python 3.8`.\n\n## Install Paramiko\n\nRun the following command in the terminal to install the `paramiko` library globally\n\n```sh\npip install paramiko\n```\n\n## SFTP Server\n\nIt is suggested that we have an SFTP server up and running in order to test the script. Our server can assist us in configuring the setup to our liking.\n\nIf you do not want to set up or have an SFTP server to test on, we can utilise several publicly available servers. A list of servers may be found [here](https://www.sftp.net/public-online-sftp-servers).\n\n# How to use the library\n\nNow let's start discussing how to use the library. We'll be talking about the following in upcoming sections.\n\n- Connecting to the remote server\n- Executing commands on the server\n- Transferring files (Upload/Download)\n- The final script\n\n## Connecting to the remote server\n\nFirst let's define the constants for connection properties like hostname, username, password, public key, private key etc.., In a real-world application, these properties should come from a configuration file/system.\n\n```python\n# There might be others based on the SFTP configuration\nHOST_NAME = \"test.rebex.net\"\nUSER_NAME = \"demo\"\nPASSWORD = \"password\"\nPRIVATE_KEY_FILE = '/some/file/path/private_key.txt'\nPORT = 22\n```\n\nTo connect to the server we create an instance `client` of `paramiko.SSHClient()`. [Paramiko.SSHClient](https://docs.paramiko.org/en/stable/api/client.html) is the primary class used to make connections to the remote server and execute commands. This class wraps [Transport](https://docs.paramiko.org/en/stable/api/transport.html), [Channel](https://docs.paramiko.org/en/stable/api/channel.html), and [SFTPClient](https://docs.paramiko.org/en/stable/api/client.html#paramiko.client.SSHClient) to take care of most(not all as discussed below) aspects of authenticating and opening channels. The creation of an SSHClient object allows establishing server connections via the [`connect()`](https://docs.paramiko.org/en/stable/api/client.html#paramiko.client.SSHClient.connect) method.\n\n## Password-based auth\n\n```python\nclient = paramiko.SSHClient()\nclient.connect(hostname=HOST_NAME, port=PORT, username=USER_NAME, password=PASSWORD)\n```\n\n[`connect()`](https://docs.paramiko.org/en/stable/api/client.html#paramiko.client.SSHClient.connect) method has support for a wide variety of ways to authenticate before connecting to the server for a user. The above-mentioned method is for password-based authentication.\n\nFor private key-based auth, instead of passing the password parameter, we can instead pass `pkey` an object of type [PKey](https://docs.paramiko.org/en/stable/api/keys.html#paramiko.pkey.PKey) or `key_filename` the list of private key file names.\n\n## Private key-based auth\n\n```python\n# Passing the PKey object\nclient = paramiko.SSHClient()\npkey = paramiko.RSAKey.from_private_key_file(PRIVATE_KEY_FILE)\nclient.connect(hostname=HOST_NAME, port=PORT, username=USER_NAME, pkey=pkey)\n\n# Passing private key file path\nclient = paramiko.SSHClient()\nclient.connect(hostname=HOST_NAME, port=PORT, username=USER_NAME, key_filename=PRIVATE_KEY_FILE)\n```\n\nHowever, [`connect()`](https://docs.paramiko.org/en/stable/api/client.html#paramiko.client.SSHClient.connect) method doesn't support 2-Factor authentication. Following are a few examples where the above method might not work.\n\n- SFTP server is enabled with both password and private key-based auth.\n- SFTP server needs an OTP post entering the password to login into the server.\n\nFor use cases like these instead of creating an object of [Paramiko.SSHClient](https://docs.paramiko.org/en/stable/api/client.html) we can create [Paramiko.Transport](https://docs.paramiko.org/en/stable/api/transport.html) instead. Transport method has a support to authenticate the connection after successful negotiation by the methods like [auth_password](https://docs.paramiko.org/en/stable/api/transport.html#paramiko.transport.Transport.auth_password), [auth_publickey](https://docs.paramiko.org/en/stable/api/transport.html#paramiko.transport.Transport.auth_publickey), [auth_interactive](https://docs.paramiko.org/en/stable/api/transport.html#paramiko.transport.Transport.auth_interactive) etc..,\n\n### Password and Private key-based auth\n\nFollowing are a few sample code snippets for the usage of above mentioned methods\n\n```python\ntransport = paramiko.Transport()\ntransport.start_client()\ntransport.auth_password(USER_NAME, PASSWORD)\npkey = paramiko.RSAKey.from_private_key_file(PRIVATE_KEY_FILE)\ntransport.auth_publickey(USER_NAME, pkey)\n```\n\n### Password and OTP based auth\n\nHere we use [`auth_interactive`](https://docs.paramiko.org/en/stable/api/transport.html#paramiko.transport.Transport.auth_interactive) method which accepts a handler for passing the values to the prompt. The custom handler that we write has the logic to pass the OTP or Password etc.. based on the output in the prompt. If we want to get the input to the handler from `stdin` instead then we can use the [`auth_interactive_dumb`](https://docs.paramiko.org/en/stable/api/transport.html#paramiko.transport.Transport.auth_interactive_dumb) method.\n\n```python\ntransport = paramiko.Transport()\ntransport.start_client()\ntransport.auth_interactive(username, handler)\n\ndef handler(self, title, instructions, prompt_list):\n        answers = []\n        for prompt_, _ in prompt_list:\n            prompt = prompt_.strip().lower()\n            if prompt.startswith('password'):\n                answers.append(PASSWORD)\n            elif prompt.startswith('verification'):\n                answers.append(OTP)\n            else:\n                raise ValueError('Unknown prompt: {}'.format(prompt_))\n        return answers\n\n```\n\n# Executing commands on the server\n\nAfter we have successfully logged into the server by any one of the above-mentioned methods executing the commands is as simple as passing your command to [exec_command](https://docs.paramiko.org/en/2.9/api/client.html#paramiko.client.SSHClient.exec_command).\n\n```python\ncommand = \"ls -l\"\nstdin, stdout, stderr = client.exec_command(command)\nprint(stdout.read())\n```\n\nHowever paramiko has some very useful util methods to run SFTP commands on the server, following are a few of them\n\n```python\nsftp_client = client.open_sftp()\nsftp_client.chdir() # Changing the directory\nsftp_client.cwd() # Get the current working directory\nsftp_client.listdir() # List all the contents of the current working directory\n```\n\nFor other supported commands, we can refer to [this documentation](https://docs.paramiko.org/en/stable/api/sftp.html).\n\n# File Transfers\n\nParamiko allows to programmatically send and receive files using the SFTP protocol. To upload/download file we need to create an [`SFTPClient`](https://docs.paramiko.org/en/stable/api/sftp.html#paramiko.sftp_client.SFTPClient) session object by calling [`open_sftp()`](https://docs.paramiko.org/en/stable/api/client.html?highlight=open_sftp#paramiko.client.SSHClient.open_sftp). This object allows to perform common SFTP operations like [`get()`](https://docs.paramiko.org/en/stable/api/sftp.html#paramiko.sftp_client.SFTPClient.get), [`put()`](https://docs.paramiko.org/en/stable/api/sftp.html#paramiko.sftp_client.SFTPClient.put).\n\n## Upload File\n\n```python\nsftp_client= client.open_sftp()\nsftp_client.put(uploadlocalfilepath,uploadremotefilepath)\nsftp_client.close()\n```\n\n## Download File\n\n```python\nsftp_client= client.open_sftp()\nsftp_client.get(downloadremotefilepath,downloadlocalfilepath)\nsftp_client.close()\n```\n\n# The final script\n\nNavigate to [this link](https://gist.github.com/me-manikanta/aa9e0fd11ba2757521b6e1c5265ac29a#file-paramiko_example-py) for the gist of the following script. Star ⭐️ the gist if it helped you.\n\n# References\n\n- Official Paramiko [documentation](https://docs.paramiko.org/en/stable/#) can be a good start for exploring other features of the library\n- [pysftp vs paramiko](https://stackoverflow.com/questions/48434941/pysftp-vs-paramiko)\n- [SSH using Python Paramiko](SSH using Python Paramiko)\n"},"__N_SSG":true}