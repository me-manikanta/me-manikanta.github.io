<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/c9e5f38208298828.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c9e5f38208298828.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-90596b3d4cf9ef23.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-202f308c0fcc394c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7f02ec35adc17966.js" defer=""></script><script src="/_next/static/chunks/605040ef-0d66b071ab1fd25f.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-e5c9e86cb81dd2b3.js" defer=""></script><script src="/_next/static/VjB_uoIuQ7n4tHlvlqSoh/_buildManifest.js" defer=""></script><script src="/_next/static/VjB_uoIuQ7n4tHlvlqSoh/_ssgManifest.js" defer=""></script><script src="/_next/static/VjB_uoIuQ7n4tHlvlqSoh/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="flex flex-col justify-center px-8"><nav class="flex items-center justify-between w-full relative max-w-2xl border-gray-200 dark:border-gray-700 mx-auto pt-8 pb-8 sm:pb-16  text-gray-900 bg-gray-50  dark:bg-gray-900 bg-opacity-60 dark:text-gray-100"><div class="ml-[-0.60rem]"><button class="mobile-menu_burger__wvd0z visible md:hidden" aria-label="Toggle menu" type="button"><svg class="h-5 w-5 absolute text-gray-900 dark:text-gray-100" width="20" height="20" viewBox="0 0 20 20" fill="none" data-hide="false"><path d="M2.5 7.5H17.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2.5 12.5H17.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg><svg class="h-5 w-5 absolute text-gray-900 dark:text-gray-100" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none" shape-rendering="geometricPrecision" data-hide="true"><path d="M18 6L6 18"></path><path d="M6 6l12 12"></path></svg></button><a class="font-normal text-gray-600 dark:text-gray-400 hidden md:inline-block p-1 sm:px-3 sm:py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 transition-all" href="/"><span>Home</span></a><a class="font-normal text-gray-600 dark:text-gray-400 hidden md:inline-block p-1 sm:px-3 sm:py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 transition-all" href="/about"><span>About</span></a></div><button aria-label="Toggle Dark Mode" type="button" class="w-9 h-9 bg-gray-200 rounded-lg dark:bg-gray-600 flex items-center justify-center  hover:ring-2 ring-gray-300  transition-all"></button></nav></div><main id="skip" class="flex flex-col justify-center px-8 bg-gray-50 dark:bg-gray-900"><div class="w-full prose dark:prose-dark mx-auto"><h1 class="text-center mb-1">Splitwise Automation to send expense updates</h1><hr class="mt-4"/><article><h1>Introduction</h1><p>If you are reading this I assume you know about <a href="https://www.splitwise.com">splitwise</a> application. A one-line summary in their words is <em>&quot;Splitwise is a free tool for friends and roommates to track bills and other shared expenses so that everyone gets paid back&quot;</em></p><p>I use another app called <a href="https://moneymanagerapp.com/">money manager</a> for personal expenses, but instead of jumping between applications I always wanted one app to track all my expenses. I was about to send feedback to Splitwise to add a feature where I can add costs only where I am involved, interestingly enough many users needed <a href="http://feedback.splitwise.com/forums/162446-general/suggestions/4084332-track-personal-expenses">this feature</a> and thanks to them the Splitwise team have suggested <a href="http://feedback.splitwise.com/forums/162446-general/suggestions/4084332-track-personal-expenses">a way</a> to do it.</p><p>All my expenses are in the same app, now what? Although all my expenses are in the same place, Splitwise doesn&#x27;t have a feature to tell me how much I&#x27;ve spent in the previous month across the application. So the curious person in me wanted to solve this problem, that is how this <a href="https://manicodes.hashnode.dev/series/side-project-sunday">Side-Project-Sunday</a> is born.</p><h1>Requirements</h1><p>Now as the storytime is done, let&#x27;s list down all the requirements</p><ol><li>Ability to get the total expense</li></ol><ul><li><p>For a given date/date range</p></li><li><p>For a given friend(s)/group(s)</p></li></ul><ol><li>Output a pie chart for a given date range</li></ol><ul><li><p>For Group-wise expenses</p></li><li><p>For Category-wise expenses</p></li></ul><ol><li>Send an email on the first day of the month, with the following template</li></ol><p>![sample_email.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1662314990904/PiNq43eCu.png align=&quot;left&quot;)</p><h1>Research</h1><h2>Fetching data</h2><p>With a quick googling about how we can do it, I found that Splitwise is supported in automation apps like <a href="https://zapier.com">Zapier</a>, <a href="https://www.make.com/en">make</a> etc.., although with a little bit of effort we can use these apps to fulfil my requirements, I thought it would be better if I code it myself so that I&#x27;ll have more control on the output.</p><p>Further googling landed me on Splitwise <a href="https://dev.splitwise.com">dev documentation</a> and I am so happy that there are a few developers who have developed third-party SDKs using the exposed APIs.</p><p>As I was planning to write a python script to implement this, I decided to use <a href="https://github.com/namaggarwal/splitwise">this python implementation</a> by <a href="https://github.com/namaggarwal/">namaggarwal</a> for my automation.</p><h2>Email notification</h2><p>For sending out the email, I wanted to use Gmail&#x27;s SMTP server to send out the email. A quick search through the web helped me understand how I can do it. I&#x27;ve linked all the references that I&#x27;ve taken help from at the end of the article.</p><h2>Scheduling</h2><p>As I was planning to push my script to GitHub, I was thinking to have a GitHub action to run my script on a regular interval. GitHub supports multiple ways of triggering actions, of which one is <a href="https://en.wikipedia.org/wiki/Cron#CRON_expression">cron expression</a>. This should help me in running the script at the end of every month.</p><h1>Implementation</h1><p>At first, I started exploring the <a href="https://github.com/namaggarwal/splitwise">SDK</a> to understand all the APIs I could use to fulfil my requirements.</p><h2>Setup</h2><p>First I&#x27;ve created a new application in <a href="https://secure.splitwise.com/apps/new">Splitwise</a>, this generates <code>Consumer Key</code> and <code>Consumer Secret</code> for us which we&#x27;ll be using to authenticate our calls.</p><p>![image.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1662575588158/7mfG2lJU4.png align=&quot;left&quot;)</p><p>As I plan to use this for a personal use case I&#x27;ve generated an API key, instead of going through the hassle of setting up OAuth1/OAuth2.</p><h2>Let&#x27;s play with the API</h2><p>Let&#x27;s go through all the APIs that Splitwise supports and list down the methods in which we are interested.</p><h3>Get all expenses of the current user</h3><p>This API is so powerful that most of our logic will rely on this, the <code>getExpenses</code> method supports a wide variety of filters with which we can filter the data based on <code>createdDate</code>, <code>updatedDate</code>, <code>groupIds</code>, <code>friendIds</code> etc.., As I&#x27;ll need the data for the past month, I&#x27;ll just get all the expenses for the previous month date range. Unfortunately, this API doesn&#x27;t give us all the details in one network call hence we need to get all the data by making multiple network calls.</p><pre data-language="py">s = Splitwise(CONSUMER_KEY, CONSUMER_SECRET, api_key=API_KEY)
expenses = []
current_page_num = 0
page_size = 100

while True:
    curr_page_expenses = s.getExpenses(
        dated_after=start_date,
        dated_before=end_date,
        limit=page_size,
        offset=current_page_num * page_size,
    )
    if len(curr_page_expenses) == 0:
        break
    current_page_num = current_page_num + 1
    expenses = expenses + curr_page_expenses
</pre><h3>Get all Groups and Friends</h3><p>The <code>getGroups</code> and <code>getFriends</code> method fetches us all the friends and group data to us which we can map with the expense data that we&#x27;ve fetched earlier.</p><pre data-language="py">groups = s.getGroups()
friends = s.getFriends()
</pre><p>We can traverse through friends&#x27; data and filter out friends where we owe them or where we are owed.</p><pre data-language="py">def get_friends_with_outstanding_table(friends):
    friends_with_outstanding_balances = []
    for f in friends:
        balance = sum(map(lambda b: float(b.amount), f.balances))
        if balance != 0:
            color = &quot;red&quot; if balance &lt; 0 else &quot;green&quot;
            friends_with_outstanding_balances.append([f.first_name, balance, color])

    friends_with_outstanding_balances.sort(key=lambda f: f[1], reverse=True)
    return friends_with_outstanding_balances
</pre><h2>Visualization</h2><p>When it comes to visualization in python, most of us are familiar with matplotlib. The same is the case with me, so I used matplotlib to generate the charts.</p><h2>Email notification</h2><p>As I mentioned earlier, I wanted to use Gmail&#x27;s SMTP server to send out emails. There are plenty of articles available on how to setup and send out emails using Gmail which I&#x27;ll link at the end of the article.</p><h2>Scheduling the script</h2><p>Let&#x27;s first create a Github action to run our script and send out the email. Let the name of the job be send-email</p><pre data-language="yml">jobs:
  send-mail:
    runs-on: ubuntu-latest
    
    steps:
</pre><p>The first step of our job is to checkout the repository with the default branch. There is already an action available in GitHub Action Marketplace for this.</p><pre data-language="yml">jobs:
  send-mail:
    runs-on: ubuntu-latest
    
    steps:    
      - name: Checkout Repos
        uses: actions/checkout@v2.4.2
</pre><p>Next, set up the python environment so that our script can run without any issues. I&#x27;ll be using setup-python from marketplace to install python and pip.</p><pre data-language="yml">jobs:
  send-mail:
    runs-on: ubuntu-latest

    steps:
    
      - name: Checkout Repos
        uses: actions/checkout@v2.4.2
    
      - name: Setup Python
        uses: actions/setup-python@v4.2.0
        with:
          python-version: 3.8.0
          cache: pip
          architecture: x64
          update-environment: true
</pre><p>Finally, let&#x27;s install all the required libraries using pip and then run our script.</p><pre data-language="yml">jobs:
  send-mail:
    runs-on: ubuntu-latest

    steps:
    
      - name: Checkout Repos
        uses: actions/checkout@v2.4.2
    
      - name: Setup Python
        uses: actions/setup-python@v4.2.0
        with:
          python-version: 3.8.0
          cache: pip
          architecture: x64
          update-environment: true
          
      - name: Install required dependencies
        run: python -m pip install -r requirements.txt
      
      - name: Run Automation
        run: python main.py
</pre><p>As our action is ready to go, let&#x27;s now try to schedule the action at regular intervals. GitHub supports cron expressions as <code>schedule</code> which we&#x27;ll be using to schedule our script to run on the 1st of every month.</p><pre data-language="plaintext">on:
  push:
    branches: [ &quot;main&quot; ]
  schedule:
    - cron: 0 10 1 * *
</pre><p>The complete yml file can be found <a href="https://github.com/me-manikanta/SplitwiseAutomation/blob/main/.github/workflows/main.yml">here</a>.</p><h1>References</h1><ul><li><p><a href="https://dev.splitwise.com/">Splitwise Documentation</a></p></li><li><p><a href="https://splitwise.readthedocs.io/en/latest/">Python SDK for Splitwise</a></p></li><li><p><a href="https://geekflare.com/send-gmail-in-python/">Send mails using Gmail Account</a></p></li><li><p><a href="https://stackoverflow.com/a/52329759">Inline images when sending emails in python</a></p></li><li><p><a href="https://docs.github.com/en/actions">Github Actions Documentation</a></p></li><li><p><a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onschedule">Schedule Github Action</a></p></li></ul></article></div><footer class="flex flex-col justify-center items-start max-w-2xl mx-auto w-full mb-8"><hr class="w-full border-1 border-gray-200 dark:border-gray-800 mb-8"/><div class="w-full max-w-2xl grid grid-cols-1 gap-4 pb-16 sm:grid-cols-3"><div class="flex flex-col space-y-4"><a class="text-gray-500 hover:text-gray-600 transition" href="/">Home</a><a class="text-gray-500 hover:text-gray-600 transition" href="/about">About</a></div><div class="flex flex-col space-y-4"><a class="text-gray-500 hover:text-gray-600 transition" target="_blank" rel="noopener noreferrer" href="https://twitter.com/me_manikanta">Twitter</a><a class="text-gray-500 hover:text-gray-600 transition" target="_blank" rel="noopener noreferrer" href="https://github.com/me-manikanta">GitHub</a><a class="text-gray-500 hover:text-gray-600 transition" target="_blank" rel="noopener noreferrer" href="https://in.linkedin.com/in/manikantainugurthi">Linkedin</a></div></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{"title":"Splitwise Automation to send expense updates","date":"September 28, 2022"},"slug":"splitwise-automation","content":"\n# Introduction\n\nIf you are reading this I assume you know about [splitwise](https://www.splitwise.com) application. A one-line summary in their words is *\"Splitwise is a free tool for friends and roommates to track bills and other shared expenses so that everyone gets paid back\"*\n\nI use another app called [money manager](https://moneymanagerapp.com/) for personal expenses, but instead of jumping between applications I always wanted one app to track all my expenses. I was about to send feedback to Splitwise to add a feature where I can add costs only where I am involved, interestingly enough many users needed [this feature](http://feedback.splitwise.com/forums/162446-general/suggestions/4084332-track-personal-expenses) and thanks to them the Splitwise team have suggested [a way](http://feedback.splitwise.com/forums/162446-general/suggestions/4084332-track-personal-expenses) to do it.\n\nAll my expenses are in the same app, now what? Although all my expenses are in the same place, Splitwise doesn't have a feature to tell me how much I've spent in the previous month across the application. So the curious person in me wanted to solve this problem, that is how this [Side-Project-Sunday](https://manicodes.hashnode.dev/series/side-project-sunday) is born.\n\n# Requirements\n\nNow as the storytime is done, let's list down all the requirements\n\n1. Ability to get the total expense\n\n* For a given date/date range\n\n* For a given friend(s)/group(s)\n\n1. Output a pie chart for a given date range\n\n* For Group-wise expenses\n\n* For Category-wise expenses\n\n1. Send an email on the first day of the month, with the following template\n\n![sample_email.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1662314990904/PiNq43eCu.png align=\"left\")\n\n# Research\n\n## Fetching data\n\nWith a quick googling about how we can do it, I found that Splitwise is supported in automation apps like [Zapier](https://zapier.com), [make](https://www.make.com/en) etc.., although with a little bit of effort we can use these apps to fulfil my requirements, I thought it would be better if I code it myself so that I'll have more control on the output.\n\nFurther googling landed me on Splitwise [dev documentation](https://dev.splitwise.com) and I am so happy that there are a few developers who have developed third-party SDKs using the exposed APIs.\n\nAs I was planning to write a python script to implement this, I decided to use [this python implementation](https://github.com/namaggarwal/splitwise) by [namaggarwal](https://github.com/namaggarwal/) for my automation.\n\n## Email notification\n\nFor sending out the email, I wanted to use Gmail's SMTP server to send out the email. A quick search through the web helped me understand how I can do it. I've linked all the references that I've taken help from at the end of the article.\n\n## Scheduling\n\nAs I was planning to push my script to GitHub, I was thinking to have a GitHub action to run my script on a regular interval. GitHub supports multiple ways of triggering actions, of which one is [cron expression](https://en.wikipedia.org/wiki/Cron#CRON_expression). This should help me in running the script at the end of every month.\n\n# Implementation\n\nAt first, I started exploring the [SDK](https://github.com/namaggarwal/splitwise) to understand all the APIs I could use to fulfil my requirements.\n\n## Setup\n\nFirst I've created a new application in [Splitwise](https://secure.splitwise.com/apps/new), this generates `Consumer Key` and `Consumer Secret` for us which we'll be using to authenticate our calls.\n\n![image.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1662575588158/7mfG2lJU4.png align=\"left\")\n\nAs I plan to use this for a personal use case I've generated an API key, instead of going through the hassle of setting up OAuth1/OAuth2.\n\n## Let's play with the API\n\nLet's go through all the APIs that Splitwise supports and list down the methods in which we are interested.\n\n### Get all expenses of the current user\n\nThis API is so powerful that most of our logic will rely on this, the `getExpenses` method supports a wide variety of filters with which we can filter the data based on `createdDate`, `updatedDate`, `groupIds`, `friendIds` etc.., As I'll need the data for the past month, I'll just get all the expenses for the previous month date range. Unfortunately, this API doesn't give us all the details in one network call hence we need to get all the data by making multiple network calls.\n\n```py\ns = Splitwise(CONSUMER_KEY, CONSUMER_SECRET, api_key=API_KEY)\nexpenses = []\ncurrent_page_num = 0\npage_size = 100\n\nwhile True:\n    curr_page_expenses = s.getExpenses(\n        dated_after=start_date,\n        dated_before=end_date,\n        limit=page_size,\n        offset=current_page_num * page_size,\n    )\n    if len(curr_page_expenses) == 0:\n        break\n    current_page_num = current_page_num + 1\n    expenses = expenses + curr_page_expenses\n```\n\n### Get all Groups and Friends\n\nThe `getGroups` and `getFriends` method fetches us all the friends and group data to us which we can map with the expense data that we've fetched earlier.\n\n```py\ngroups = s.getGroups()\nfriends = s.getFriends()\n```\n\nWe can traverse through friends' data and filter out friends where we owe them or where we are owed.\n\n```py\ndef get_friends_with_outstanding_table(friends):\n    friends_with_outstanding_balances = []\n    for f in friends:\n        balance = sum(map(lambda b: float(b.amount), f.balances))\n        if balance != 0:\n            color = \"red\" if balance \u003c 0 else \"green\"\n            friends_with_outstanding_balances.append([f.first_name, balance, color])\n\n    friends_with_outstanding_balances.sort(key=lambda f: f[1], reverse=True)\n    return friends_with_outstanding_balances\n```\n\n## Visualization\n\nWhen it comes to visualization in python, most of us are familiar with matplotlib. The same is the case with me, so I used matplotlib to generate the charts.\n\n## Email notification\n\nAs I mentioned earlier, I wanted to use Gmail's SMTP server to send out emails. There are plenty of articles available on how to setup and send out emails using Gmail which I'll link at the end of the article.\n\n## Scheduling the script\n\nLet's first create a Github action to run our script and send out the email. Let the name of the job be send-email\n\n```yml\njobs:\n  send-mail:\n    runs-on: ubuntu-latest\n    \n    steps:\n```\n\nThe first step of our job is to checkout the repository with the default branch. There is already an action available in GitHub Action Marketplace for this.\n\n```yml\njobs:\n  send-mail:\n    runs-on: ubuntu-latest\n    \n    steps:    \n      - name: Checkout Repos\n        uses: actions/checkout@v2.4.2\n```\n\nNext, set up the python environment so that our script can run without any issues. I'll be using setup-python from marketplace to install python and pip.\n\n```yml\njobs:\n  send-mail:\n    runs-on: ubuntu-latest\n\n    steps:\n    \n      - name: Checkout Repos\n        uses: actions/checkout@v2.4.2\n    \n      - name: Setup Python\n        uses: actions/setup-python@v4.2.0\n        with:\n          python-version: 3.8.0\n          cache: pip\n          architecture: x64\n          update-environment: true\n```\n\nFinally, let's install all the required libraries using pip and then run our script.\n\n```yml\njobs:\n  send-mail:\n    runs-on: ubuntu-latest\n\n    steps:\n    \n      - name: Checkout Repos\n        uses: actions/checkout@v2.4.2\n    \n      - name: Setup Python\n        uses: actions/setup-python@v4.2.0\n        with:\n          python-version: 3.8.0\n          cache: pip\n          architecture: x64\n          update-environment: true\n          \n      - name: Install required dependencies\n        run: python -m pip install -r requirements.txt\n      \n      - name: Run Automation\n        run: python main.py\n```\n\nAs our action is ready to go, let's now try to schedule the action at regular intervals. GitHub supports cron expressions as `schedule` which we'll be using to schedule our script to run on the 1st of every month.\n\n```plaintext\non:\n  push:\n    branches: [ \"main\" ]\n  schedule:\n    - cron: 0 10 1 * *\n```\n\nThe complete yml file can be found [here](https://github.com/me-manikanta/SplitwiseAutomation/blob/main/.github/workflows/main.yml).\n\n# References\n\n* [Splitwise Documentation](https://dev.splitwise.com/)\n\n* [Python SDK for Splitwise](https://splitwise.readthedocs.io/en/latest/)\n\n* [Send mails using Gmail Account](https://geekflare.com/send-gmail-in-python/)\n\n* [Inline images when sending emails in python](https://stackoverflow.com/a/52329759)\n\n* [Github Actions Documentation](https://docs.github.com/en/actions)\n\n* [Schedule Github Action](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onschedule)\n"},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"splitwise-automation"},"buildId":"VjB_uoIuQ7n4tHlvlqSoh","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>